---
layout: post
title: 虚拟机学习笔记
date: 2019-02-16 12:11:00
tags: design java
categories: java
excerpt: JVM基本结构的理解
---

## `java`虚拟机的基本结构

​	![jvm](\img\jvm.png)

**类加载子系统：**

> 负责从文件系统或网络中加载Class信息,加载的信息存放在一块称之为方法区的内存空间

**方法区：** 

> 存放类信息、常量信息、常量池信息，包括字符串字面量和数字常量等

**`java`堆：**

>在`java`虚拟机启动的时候建立`java`堆，他是`java`程序最主要的内存工作区域，几乎所有的对象实例都存放到`java`堆中，堆空间是所有线程共享的

​	整个`java`堆可分为新生代和老年代，新生代存放新生的对象或者年龄不大的对象，老年代则存放老年对象。

**直接内存：**

> `java`的`NIO`库允许`java`程序使用直接内存，从而提高性能，通常直接内存速度会优于`java`堆，读写频繁的场合可能会考虑使用

**`java`栈：**

> 每个虚拟机线程都有一个私有的栈，一个线程的`java`栈在线程创建得时候被创建，`java`栈中保存着局部变量、方法参数、同时`java`的方法调用、返回值等。

​	一个栈，一般由三个部分组成：局部变量表，操作数栈和帧数据区。

**本地方法栈：**

> 本地方法栈和`java`栈非常类似，最大不同为本地方法栈为本地方法调用。`java`虚拟机允许`java`直接调用本地方法(通常使用C编写)

**垃圾收集器：**

> 垃圾收集系统是`java`的核心，也是必不可少的，`java`有一套自己进行垃圾清理的机制，开发人员无需手工清理

- 垃圾收集算法：

  ​	**`复制算法：`**其核心思想就是将内存空间分为两块，每次只使用其中一块，在垃圾回收时，将正在使用的内存中的存留对象复制到未被使用的内存块中去，之后去清除之前正在使用的内存块中所有的对象，反复去交换两个内存的角色，完成垃圾收集。

  ​	这样使得每次都是对整个半区进行内存回收，内存分配时也就不用考虑内存碎片等复杂情况，按顺序分配内存即可，实现简单，运行高效

**PC（Program Counter）：**

> 寄存器也是每个线程私有的空间，`java`虚拟机会为每个线程创建PC寄存器，在任意时刻，一个`java`线程总是在执行一个方法，这个方法被称为当前方法，如果当前方法不是本地方法，PC寄存器就会执行当前正在被执行的指令，如果是本地方法，则PC寄存器值为undefined，寄存器存放如当前执行环境指针、程序计数器、操作栈指针、计算的变量指针等信息。

**执行引擎：**

> 负责执行虚拟机的字节码，一般是用户先编译成机器码后再执行，（`虚拟机最核心的组件`）

**虚拟机参数**

- 堆分配参数

  **`-XX:`**对系统级别的（`JVM`）配置日志信息 或者说配置`jvm`使用什么垃圾回

  非-XX基本上是对应用层面上的配置

  **`+:`**启用；**`-:`**禁用

  > `-XX:+PrintGC` 使用这个参数,虚拟机启动之后，只要遇到GC就会打印日志。
  >
  > `-XX:+UseSerialGC` 配置串行回收器
  >
  > `-XX:+PrintGCDetails` 可以查看详细信息，包括各个区的情况
  >
  > `-Xms:` 设置java程序启动时初始堆的大小
  >
  > `-Xmx:`设置java程序能获得最大堆大小
  >
  > `-Xmx20m -Xms5m -XX:+PrintCommandLineFlags:`可以将隐士或者显示传给虚拟机的参数输出

  新生代的配置：

  > `-Xmn:`可以设置新生代的大小，设置一个比较大的新生代会减少老年代的大小，这个参数对系统性能以及`GC`行为有很大的影响，新生代一般会设置整个堆空间的1/3到1/4左右
  >
  > `-XX:SurvivorRatio:`用来设置新生代中`edun`空间和`from/to`空间的比例。
  >
  > ​                                        `-XX:SurvivorRati=eden/from=eden/to`

  `总结：不同的堆分布情况，对系统的执行会产生 一定的影响，在实际工作中，应该根据系统的特点做出合理的配置，基本策略：尽可能将对象预留在新生代，减少老年代的GC次数。`

  `除了可以设置新生代的绝对大小（-Xmn）,还可以使用（-XX:NewRatio）设置新生代和老年代的比例：-XX:NewRatio=老年代/新生代`